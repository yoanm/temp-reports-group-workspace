# To store on same repo as reports-group/codacy-uploader-action action if doable !
name: 'Codacy report groups upload'
on:
  workflow_call:
    inputs:
      artifacts-pattern:
        description: TODO
        required: true
        type: string
      run-id:
        description: |
          The id of the workflow run where the artifacts were uploaded from (default to current run).
          In case artifacts have been uploadded from another run, this input must be filled with original workflow run id !
        required: false
        type: string
        default: "${{ github.run_id }}"
      language: # @TODO see if doable to embed it on group metadata !
        description: Force the language linked to the uploaded reports.
        type: string
        required: false
      force-coverage-parser: # @TODO see if doable to embed it on group metadata ! (extra properties ?)
        description: Force the coverage parser used to parse uploaded reports
        type: string
        required: false
      coverage-reporter-version: # @TODO see if doable to embed it on group metadata ! (extra properties ?)
        description: Force CLI uploader version
        type: string
        required: false
#      override-commit:
#        description: |
#          Force the commit SHA linked to the uploaded reports.
#          Mostly useful for specific cases (e.g. `workflow_run` workflow).
#        required: false
#        type: string
      follow-symbolic-links:
        description: Indicates whether to follow symbolic links when resolving groups path
        required: false
        type: boolean
        default: false

    secrets:
      PROJECT_TOKEN:
        required: true
    outputs:
      groups:
        description: TODO
        value: ${{ jobs.upload.outputs.groups }}
      reports:
        description: TODO
        value: ${{ jobs.upload.outputs.reports }}

jobs:
  upload:
    name: Upload all reports
    runs-on: ubuntu-latest
    outputs:
      groups: ${{ steps.upload.outputs.groups }}
      reports: ${{ steps.upload.outputs.reports }}
    permissions:
      contents: read
      checks: write # For the check run creation ! @TODO check if doable to use inputs there and set read rather than write if ${{ !inputs.with-check-run }}
    steps:
      - name: 'Check run â—‹'
        uses: yoanm/temp-reports-group-workspace/.github/actions/attach-check-run-to-triggering-workflow-action@develop
        if: ${{ 'workflow_run' == github.event_name }}

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ${{ inputs.artifacts-pattern }}
          path: job-artifacts
          github-token: ${{ github.token }} # Required in order to use `run-id` parameter !
          run-id: ${{ inputs.run-id }} # Required in case workflow is executed from another run (e.g. `workflow_run`)

      - name: Upload all reports
        id: upload
        uses: yoanm/temp-reports-group-workspace/.github/actions/codacy-uploader-action@develop
        with:
          path: job-artifacts
          project-token: ${{ secrets.PROJECT_TOKEN }}
          language: ${{ inputs.language }}
          force-coverage-parser: ${{ inputs.force-coverage-parser }}
          coverage-reporter-version: ${{ inputs.coverage-reporter-version }}
          # override-commit: ${{ inputs.override-commit }} Codacy uploader do not manage overridden commit https://github.com/codacy/codacy-coverage-reporter-action/pull/83
          follow-symbolic-links: ${{ inputs.follow-symbolic-links }}

      - name: DEBUG
        run: |
          echo 'outputs='"'"'${{ toJson(steps.upload.outputs) }}'"'"
